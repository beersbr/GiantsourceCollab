<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title></title>
<style>
canvas{ background: url("swamp.jpg") no-repeat; }
</style>

	<script src="keyboard.js"></script>

<script>

    requestAnimFrame = (function () {
        return window.requestAnimationFrame ||
            	window.webkitRequestAnimationFrame ||
            	window.mozRequestAnimationFrame ||
            	window.oRequestAnimationFrame ||
            	window.msRequestAnimationFrame ||
            	function (/* function FrameRequestCallback */ callback, /* DOMElement Element */ element) {
            	    window.setTimeout(callback, 1000 / 60);
            	};
    })();



    GAME = (function () {



        function Enemy() {
            var rand = RandomInt(3);
           
            var vx = 0;
            var vy = 0;
            var image = game.images["enemy"];
			 this.rect = new Rect(0, 0, image.width,image.height);
            switch (rand) {
                // Top
                case 0:
                    this.rect.x = RandomInt(game.width);
                    this.rect.y = 0;
                    vy = 100 + RandomInt(100);
                    break;
                    // Left
                case 1:
                    this.rect.x = 0;
                    this.rect.y = RandomInt(game.height);
                    vx = 100 + RandomInt(100);
                    break;
                    // Bottom
                case 2:
                    this.rect.x = RandomInt(game.width);
                    this.rect.y = game.height;
                    vy = -100 - RandomInt(100);
                    break;
                    // Right
                case 3:
                    this.rect.x = game.width;
                    this.rect.y = RandomInt(game.height);
                    vx = -100 - RandomInt(100);
                    break;

            } // end switch

            this.draw = function () {
                _renderingContext.save();
                _renderingContext.drawImage(image, 0, 0, image.width, image.height, this.rect.x, this.rect.y, this.rect.w, this.rect.h);

                //	_renderingContext.fillStyle = "rgb(0, 0, 255)";
                // 	_renderingContext.fillRect(this.rect.x, this.rect.y, this.rect.w, this.rect.h);
                _renderingContext.restore();
            }

            this.update = function () {
                var moveSpeedx = vx * (game.elapsedTime / 1000);
                var moveSpeedy = vy * (game.elapsedTime / 1000);

                this.rect.x += moveSpeedx;
                this.rect.y += moveSpeedy;

                if (this.x < 0 || this.x > game.width || this.y < 0 || this.y > game.height) return false;

                return true;
            }
        }

        function RandomInt(max) {
            return parseInt(Math.random() * max);
        }

        function collide(rect1, rect2) {
            if (rect1.x > rect2.x + rect2.w) return false;
            if (rect1.x + rect1.w < rect2.x) return false;
            if (rect1.y > rect2.y + rect2.h) return false;
            if (rect1.y + rect1.h < rect2.y) return false;
            return true;
        }


        var startTime = 0.0;

        var game = {};

        game.width = 800;
        game.height = 600;

        var _renderingContext = null;
        var keyboard = new KeyboardHandler();
		
		
		game.images = {};
		
		game.images["enemy"] = new Image();
        game.images["enemy"].src = "./enemy2.png";
        game.images["enemy"].onload = function(){ game.loadedResources += 1; }
		
		game.images["level"] = new Image();
        game.images["level"].src = "./swamp.png";
        game.images["level"].onload = function(){ game.loadedResources += 1; }
		
		
		game.images["player"] = new Image();
        game.images["player"].src = "./player.png";
        game.images["player"].onload = function(){ game.loadedResources += 1; }
		
		

        function Rect(x, y, w, h) {
            this.x = x || 0;
            this.y = y || 0;
            this.w = w || 0;
            this.h = h || 0;

            this.draw = function () {
                _renderingContext.save();
                _renderingContext.fillStyle = "rgb(255, 0, 255)";
                _renderingContext.fillRect(this.x, this.y, this.w, this.h);
                _renderingContext.restore();
            }
        }
		
		function Shoot() {
            	
				
    				//console.log('DIRECTION = ' + game.player.currentDirection);
    				var vx = 0;
    				var vy = 0;
    				switch (game.player.shootDirection) {
    					// Top
    					case 'left':
    						this.rect = new Rect(game.player.rect.x, game.player.rect.y, 25, 3);
    						
    						vx = -100;
    						break;
    						// Left
    					case 'right':
    						this.rect= new Rect(game.player.rect.x, game.player.rect.y, 25, 3);
    						vx = 100;
    						break;
    						// Bottom
    					case 'up':
    						this.rect = new Rect(game.player.rect.x, game.player.rect.y, 3, 25);
    						vy = -100;
    						break;
    						// Right
    					case 'down':
    						this.rect = new Rect(game.player.rect.x, (game.player.rect.y+(game.player.rect.h/2)), 3, 25);
    						vy = 100;
    						
    						break;
    	
    				} // end switch
                
				
				this.draw = function () {
					_renderingContext.save();
					//_renderingContext.drawImage(image, 0, 0, image.width, image.height, this.rect.x, this.rect.y, this.rect.w, this.rect.h);
	
						_renderingContext.fillStyle = "rgb(0, 0, 255)";
					 	_renderingContext.fillRect(this.rect.x, this.rect.y, this.rect.w, this.rect.h);
						_renderingContext.restore();
				
                 }

				this.update = function () {
					var moveSpeedx = vx * (game.elapsedTime / 500);
					var moveSpeedy = vy * (game.elapsedTime / 500);
	
					this.rect.x += moveSpeedx;
					this.rect.y += moveSpeedy;
	
					if (this.x < 0 || this.x > game.width || this.y < 0 || this.y > game.height)  { return false;
						
					}
					
					return true;
	
					
				}
		}
		
		
		function Player() {
          
            var image = game.images["player"];
         	this.rect = new Rect(390, 290, 41, 101);
			this.currentDirecton = null;
            this.shootDirection = null;
			this.reloading = false;
			this.zombiesKilled = 0;
            this.draw = function () {
                _renderingContext.save();
                _renderingContext.drawImage(image, 0, 0, image.width, image.height,this.rect.x,this.rect.y,this.rect.w,this.rect.h);

                //	_renderingContext.fillStyle = "rgb(0, 0, 255)";
                // 	_renderingContext.fillRect(this.rect.x, this.rect.y, this.rect.w, this.rect.h);
                _renderingContext.restore();
            }

        }


        function LoadLevel() {
          
            var image = game.images["level"];
           
            
            this.draw = function () {
                _renderingContext.save();
                
                 _renderingContext.drawImage(image, 0, 0, image.width, image.height);
                //  _renderingContext.fillStyle = "rgb(0, 0, 255)";
                //  _renderingContext.fillRect(this.rect.x, this.rect.y, this.rect.w, this.rect.h);
                _renderingContext.restore();
            }

        }

        Object.defineProperty(game, "renderingContext", {
            set: function (e) {

                var temp = _renderingContext;
                _renderingContext = e.getContext("2d");
                _renderingContext.canvas = temp;
            },
            get: function () {
                return _renderingContext;
            }
        });

        game.states = {};
        game.states.PLAYING = 1;
        game.states.GAMEOVER = 2;
        game.states.LOADING = 3;
        game.state = game.states.PLAYING;
	
        game.init = function() {
			
			game.player = new Player();
            //game.rect = new Rect(390, 290, 20, 20);
            game.time = +(new Date());
            game.totalTime = 0;
            game.score = 0;
            game.state = game.states.PLAYING;
            enemies = [];
			bullets = [];
        }
		
		
        game.init();
        game.state = game.states.LOADING;
      
        game.loadedResources = 0;
        game.totalResources = 2;

        game.resourcesLoaded = function(){ return game.loadedResources == game.totalResources; }

      

        game.run = function () {
           // LoadLevel();
            game.previousTime = game.time;
            game.time = +(new Date());
            game.elapsedTime = game.time - game.previousTime;
            game.totalTime += game.elapsedTime;
			 //var levelImage =game.images["level"];
            //_renderingContext.drawImage(levelImage, 0, 0, 800, 600);
			

            _renderingContext.fillStyle = "rgb(0, 0, 0)";
            _renderingContext.fillRect(0, 0, 800, 600);

            switch(game.state)
            {
                case game.states.LOADING:
                    (function(){
                        
                        if(game.resourcesLoaded()){
                            
                            var welcomeText = "WELCOME TO STUPID ZOMBIES - HIT ENTER TO BEGIN";
                            var welcomeLen = _renderingContext.measureText(welcomeText);
                            _renderingContext.save();
                            _renderingContext.fillStyle = "rgb(255, 255, 255)";
                            _renderingContext.fillText(welcomeText, game.width/2 - welcomeLen.width/2, 290);
                            _renderingContext.restore();

                            if(keyboard.keyPressed("enter")){
                                game.init();
                
                            }

                            //game.state = game.states.PLAYING;
                        }
                    })();

                    // draw
                    (function(){
                        var loadingText = "LOADING";
                        var loadingLen = _renderingContext.measureText(loadingText);
                        _renderingContext.save();
                        _renderingContext.fillStyle = "rgb(255, 255, 255)";
                        _renderingContext.fillText(loadingText, game.width/2 - loadingLen.width/2, 290);
                        _renderingContext.restore();
                    })();

                    break;

                case game.states.PLAYING:
                    
                    game.update();
                    game.draw();
                    break;
                case game.states.GAMEOVER:
                    // update
                    (function(){
                        if(keyboard.keyPressed("enter")){
                            game.init();
				
                        }
                    })();

                    // draw
                    (function(){
                        var scoreText = "SCORE: " + game.score;
                        var scoreLen = _renderingContext.measureText(scoreText);

                        _renderingContext.save();
                        _renderingContext.fillStyle = "rgb(255, 255, 255)";
                        _renderingContext.fillText(scoreText, game.width/2 - scoreLen.width/2, 290);
                        _renderingContext.restore();
                    })();

                    break;
            }

            keyboard.cleaner();
            requestAnimFrame(game.run);
        }

        game.update = function () {
            var moveSpeed;
            game.score = game.totalTime +(game.player.zombiesKilled*1000);
			
			var scoreText = "SCORE: " + game.score;
            var scoreLen = _renderingContext.measureText(scoreText);

             _renderingContext.fillStyle = "rgb(255, 255, 255)";
             _renderingContext.fillText(scoreText, 25, 10);
						
						
			
			if (keyboard.keyIsDown("shift")) {
                moveSpeed = 200 * (game.elapsedTime / 1000);
            } else {
				 moveSpeed = 100 * (game.elapsedTime / 1000);
				
			}
			
            // Update character movement
            if (keyboard.keyIsDown("a")) {
                game.player.rect.x -= moveSpeed;
				game.player.currentDirection = 'left';
            }
            if (keyboard.keyIsDown("d")) {
                game.player.rect.x += moveSpeed;
				game.player.currentDirection = 'right';
            }
            if (keyboard.keyIsDown("w")) {
                game.player.rect.y -= moveSpeed;
				game.player.currentDirection = 'up';
            }
            if (keyboard.keyIsDown("s")) {
                game.player.rect.y += moveSpeed;
				game.player.currentDirection = 'down';
            }

            //Shooting
			var shoot = false;
             if (keyboard.keyIsDown("left_arrow")) {
                shoot = true;
                game.player.shootDirection = 'left';
            }
            if (keyboard.keyIsDown("right_arrow")) {
                shoot = true;
                game.player.shootDirection = 'right';
            }
            if (keyboard.keyIsDown("up_arrow")) {
                shoot = true;
                game.player.shootDirection = 'up';
            }
            if (keyboard.keyIsDown("down_arrow")) {
                shoot = true;
                game.player.shootDirection = 'down';

            }

			if (shoot) {
				
				//console.log('enter');
				
			   if (!game.player.reloading) {
				   game.player.reloading = true;
				   bullets.push(new Shoot());
				   
			   } else {
				   
					 setTimeout(function() {
						 game.player.reloading = false;
					 },500)
			   }
               
            }

            // Update enemies
            if (RandomInt(game.totalTime) < game.totalTime * 0.05 )
                enemies.push(new Enemy());
            // Loop through each enemy
            for (var i = 0; i < enemies.length; ++i){
       	 
                // Check if player and enemy collided
                //console.log(enemies[i]);
                if(collide(game.player.rect,enemies[i].rect)) game.state = game.states.GAMEOVER;

                if(!enemies[i].update()){
                    // If the enemy is off the screen
                    enemies.splice(i, 1);
                }


            }
			
			 // Loop through each bullets
            for (var i = 0; i < bullets.length; ++i){
       	 			 for (var z = 0; z < enemies.length; ++z){
						 
						 try {	
						 if(collide(bullets[i].rect,enemies[z].rect))  {
								 bullets.splice(i, 1);
								 enemies.splice(z, 1);
								 game.player.zombiesKilled++;
						
							}
						 }catch(err){}
					 }
                // Check if player and enemy collided
                //console.log(enemies[i]);
               
			try {	
                if(!bullets[i].update()){
                    // If the enemy is off the screen
                    bullets.splice(i, 1);
                }
			}catch(err){}


            }
			


        }

        game.draw = function () {
            game.player.draw();

            for (var i = 0; i < enemies.length; ++i)
                enemies[i].draw();
			
			try {	
			for (var i = 0; i < bullets.length; ++i)
                bullets[i].draw();
			}catch(err){}
        }

        return game;

    })();






    window.onload = function () {
        GAME.renderingContext = document.getElementById("canvas");

        GAME.run();

    }
</script>
</head>

<body>
<canvas id="canvas" width="800px" height="600px"></canvas>
</body>
</html>








